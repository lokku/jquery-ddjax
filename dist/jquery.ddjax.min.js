/*! Deferred Dynamic PJAX - v0.1.0 - 2014-06-13
* https://github.com/lokku/ddjax
* Copyright (c) 2014 Lokku Ltd.; Licensed MIT */
!function(a,b){"use strict";a.support.cors=!0;var c,d,e=[],f=!1,g="",h=a(b),i={getLinks:function(){var a=this,b=a.data("settings"),c=b.ignoreClass,d=a.find("undefined"!=typeof c?"a":"a:not(."+c+")");return d},handleClick:function(b){var e=this,g=b.target,j=a(g),k=j.attr("href"),l=e.data("settings");if(j.hasClass("ddJAX_internal")){if(b.preventDefault(),f)return setTimeout(function(){i.clearDjaxing.call(e)},1e3),j;var m=[g];h.trigger("djaxClick",m),l.onDjaxClickCallback.call(e,m,{});var n=l.urlDataAttribute;"undefined"!=typeof n&&(c=j.data(n)),"undefined"==typeof c&&(c=k),d=!1,i.navigate.call(e,{url:k,add_to_history:!0,type:"GET"})}return e},clearDjaxing:function(){var a=this;if(f=!1,e.length){var b=e.pop();e=[];var c=b[0],d=b[1],g=b[2],h=b[3],i=b[4];j.navigate.call(a,c,d,g,h,i)}},getUrlFromHeaders:function(a,b){var c=b.getResponseHeader("TargetUrl");return(null===c||"undefined"==typeof c)&&(c=a),c},navigate:function(b){var c=this;f=!0,h.trigger("djaxLoading",[{url:b.url}]),a.ajax(i.ajaxSettings(c,b))},ajaxSettings:function(b,c){"POST"!==c.method&&(c.method="GET"),c.blocks=a(b.data("djaxBlockSelector"));var d=b.data("settings"),e=d.ajax_data_parameter;return"function"==typeof e&&(e=e()),{url:c.url,data:e,timeout:d.ajax_timeout,type:c.method,crossDomain:!0,success:i.changePage(b,c.url,c.add_to_history,c.blocks),error:i.changePageError(b,c.url,c.add_to_history,c.blocks,d.ajax_timeout_callback)}},changePage:function(a,b,d,e){return function(f,g,h){var j=i.getUrlFromHeaders.call(a,b,h);c=j,i.replaceBlocks.call(a,j,d,e,f)}},changePageError:function(a,d,e,f,g){return function(h,j,k){if("error"!==j||404!==h.status&&""!==k&&"undefined"!=typeof h.responseText)if("timeout"===j)"undefined"!=typeof timeoutCallback&&g(this);else{var l=i.getUrlFromHeaders.call(a,d,h);c=l,i.replaceBlocks.call(a,l,e,f,h.responseText)}else b.location.href=this.url}},replaceBlocks:function(e,g,j,k){var l=this,m=l.data("settings");if(e!==c)return i.navigate.call(l,{url:c,add_to_history:!1,method:"GET"}),!0;var n=l.data("djaxBlockSelector"),o=a(k);g&&b.history.pushState({url:e,title:o.filter("title").text()},o.filter("title").text(),e);var p=[];document.title=o.filter("title").text();var q=a("<div>"+k+"</div>").find(n);j.each(function(){var b,c=a(this),d="#"+c.attr("id"),e=q.filter(d);if(b="undefined"==typeof m.ignoreClass?a("a",e):a("a:not(."+m.ignoreClass+")",e),b.filter(function(){return this.hostname===location.hostname}).addClass("ddJAX_internal"),e.length){var f=c.clone().wrap("<div>").parent().html(),g=e.clone().wrap("<div>").parent().html();p.push(f!==g?{type:"replace",new_block:e,target:c}:{type:"remove",new_block:e,target:void 0})}});var r;a.each(q,function(){var b,c=a(this),d="#"+a(this).attr("id");if(!a(d).length)if(b=o.find(d).prev(),b.length)p.push({type:"insertAfter",target:b.attr("id"),new_block:c});else{var e=c.parent().attr("id");p.push(void 0===e&&void 0!==r?{type:"insertAfter",target:r.attr("id"),new_block:c}:{type:"prependTo",target:a("#"+e),new_block:c})}r=c;var f=function(b){var c;c="undefined"==typeof m.ignoreClass?a("a",b):a("a:not(."+m.ignoreClass+")",b),c.filter(function(){return this.hostname===location.hostname}).addClass("ddJAX_internal")};p.push({type:"function",target:f,args:[c]})});var s=function(){d||(a(b).trigger("djaxLoad",[{url:e,title:o.filter("title").text(),response:k}]),d=!0,f=!1)};p.push({type:"function",target:s,args:[]}),h.trigger("djaxDeferReplacements",[p])}},j={init:function(e){var j=a.extend({selector:void 0,ignoreClass:void 0,urlDataAttribute:void 0,ajax_data_parameter:{},ajax_timeout:void 0,ajax_timeout_callback:void 0,onDjaxClickCallback:function(){},onHistoryPopStateCallback:function(){}},e);return this.each(function(){var e=a(this);if(e.data("settings",j),!history.pushState)return a(this);f=!1;var k=j.selector;e.data("djaxBlockSelector",k),b.history.replaceState({url:b.location.href,title:a("title").text()},a("title").text(),b.location.href),i.getLinks.call(e).filter(function(){return this.hostname===location.hostname}).addClass("ddJAX_internal"),h.bind("popstate",function(a){if(d=!1,a.originalEvent.state){var b=a.originalEvent.state.url,f=b.split("#"),h=f.length;if(h>=2&&f[h-2].indexOf(f[h-1]))return void(g="");g!==b?(j.onHistoryPopStateCallback(),c=b,g=b,i.navigate.call(e,{url:g,add_to_history:!1,method:"GET"})):g=""}}),e.bind("click.ddjax",function(a){i.handleClick.call(e,a)})})},is_djaxing:function(){return f},navigate:function(a,b,g,j,k){var l=this;if("undefined"==typeof g&&(g=[]),f)return e.push([a,b,g,j,k]),setTimeout(function(){i.clearDjaxing.call(l)},1e3),l;d=!1,h.trigger("djaxClick",g);var m=l.data("settings");m.onDjaxClickCallback.call(l,g,k),c=a,i.navigate.call(l,{url:a,add_to_history:b,method:j})},set_ajax_data_parameter:function(a){var b=this,c=b.data("settings");c.ajax_data_parameter=a,b.data("settings",c)}};a.fn.ddjax=function(b){return j[b]?j[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error("Cannot call method "+b):j.init.apply(this,arguments)}}(jQuery,window);